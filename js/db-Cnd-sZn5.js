class e{id=-1;title;language;creator;lastReadIndex=0;totalIndex=0;file;textHTML=[];contentFileName;contentsPath;#e;static async newFromExistingObject(t,n){const r=new e;return r.id=t,r.title=n.title,r.language=n.language,r.creator=n.creator,r.lastReadIndex=n.lastReadIndex||0,r.totalIndex=n.totalIndex||0,r.file=n.file,await r.loadFromFile(),r}static async newFromFile(t){const n=new e;return n.file=t,await n.loadFromFile(),n}get object(){return{title:this.title,language:this.language,creator:this.creator,lastReadIndex:this.lastReadIndex||0,totalIndex:this.totalIndex||0,file:this.file}}async loadFromFile(){const e=await this.getZip(),t=await e.file("META-INF/container.xml").async("text"),n=(new DOMParser).parseFromString(t,"application/xml").getElementsByTagName("rootfile")[0].getAttribute("full-path");let r="";n.match(/^.*\//)&&(r=n.match(/^.*\//)[0]),this.contentsPath=r;const a=await e.file(n).async("text");this.contentFileName=n;const i=(new DOMParser).parseFromString(a,"application/xml");this.title=i.getElementsByTagName("dc:title")[0].innerHTML,this.language=i.getElementsByTagName("dc:language")[0].innerHTML,this.creator=i.getElementsByTagName("dc:creator")[0].innerHTML}async getZip(){if(this.file)return this.#e=this.#e||await JSZip.loadAsync(this.file),this.#e}async getCoverBlob(){const e=await this.getZip(),t=await e.file(this.contentFileName).async("text"),n=(new DOMParser).parseFromString(t,"application/xml"),r=n.querySelector('item[properties="cover-image"]')||n.querySelector('item[media-type="image/jpeg"]');if(r){const t=this.contentsPath+r.getAttribute("href"),n=await e.file(t).async("blob");let a=n.slice(0,n.size,"image/jpeg");return URL.createObjectURL(a)}}async loadContent(){if(!this.file)return;const e=new Date,n=await this.getZip(),r=await n.file("META-INF/container.xml").async("text"),a=(new DOMParser).parseFromString(r,"application/xml").getElementsByTagName("rootfile")[0].getAttribute("full-path");let i="";a.match(/^.*\//)&&(i=a.match(/^.*\//)[0]);const o=await n.file(a).async("text"),s=(new DOMParser).parseFromString(o,"application/xml"),c={};for(const e of n.filter((e=>e.includes(".jpg")||e.includes(".jpeg")))){const r=await n.file(e.name).async("blob");let a=r.slice(0,r.size,"image/jpeg");c[t(e.name)]=URL.createObjectURL(a)}const l=s.querySelectorAll('item[media-type="application/xhtml+xml"]');for(let e=0;e<l.length;e++){const r=i+l[e].getAttribute("href");if(r.includes("navigation"))continue;const a=await n.file(r).async("text"),o=(new DOMParser).parseFromString(a,"application/xml"),s=document.createElement("div");s.innerHTML=o.querySelector("body").innerHTML,s.setAttribute("id",t(r).slice(0,-6));const u=s.querySelectorAll("image");for(let e=0;e<u.length;e++){const n=t(u[0].getAttribute("xlink:href"));u[e].setAttribute("xlink:href",c[n])}const d=s.querySelectorAll("img");for(let e=0;e<d.length;e++)t(d[e].src),d[e].src=c[t(d[e].src)];const g=s.getElementsByTagName("a");g&&[...g].forEach((e=>e.href="#"+e.href.split("#")[1])),this.textHTML.push(s)}console.log(`Epub loaded in ${new Date-e}ms`)}}function t(e){let t=/[^/]+$/;return e.match(t)?e.match(t)[0]:e}const n=(e,t)=>t.some((t=>e instanceof t));let r,a;const i=new WeakMap,o=new WeakMap,s=new WeakMap;let c={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return i.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return g(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function l(e){c=e(c)}function u(e){return(a||(a=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(f(this),t),g(this.request)}:function(...t){return g(e.apply(f(this),t))}}function d(e){return"function"==typeof e?u(e):(e instanceof IDBTransaction&&function(e){if(i.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",i),e.removeEventListener("abort",i)},a=()=>{t(),r()},i=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",i),e.addEventListener("abort",i)}));i.set(e,t)}(e),n(e,r||(r=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,c):e)}function g(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",i)},a=()=>{t(g(e.result)),r()},i=()=>{n(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",i)}));return s.set(t,e),t}(e);if(o.has(e))return o.get(e);const t=d(e);return t!==e&&(o.set(e,t),s.set(t,e)),t}const f=e=>s.get(e);function m(e,t,{blocked:n,upgrade:r,blocking:a,terminated:i}={}){const o=indexedDB.open(e,t),s=g(o);return r&&o.addEventListener("upgradeneeded",(e=>{r(g(o.result),e.oldVersion,e.newVersion,g(o.transaction),e)})),n&&o.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),s.then((e=>{i&&e.addEventListener("close",(()=>i())),a&&e.addEventListener("versionchange",(e=>a(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),s}const p=["get","getKey","getAll","getAllKeys","count"],h=["put","add","delete","clear"],y=new Map;function w(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(y.get(t))return y.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,a=h.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!a&&!p.includes(n))return;const i=async function(e,...t){const i=this.transaction(e,a?"readwrite":"readonly");let o=i.store;return r&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),a&&i.done]))[0]};return y.set(t,i),i}l((e=>({...e,get:(t,n,r)=>w(t,n)||e.get(t,n,r),has:(t,n)=>!!w(t,n)||e.has(t,n)})));const x=["continue","continuePrimaryKey","advance"],b={},I=new WeakMap,B=new WeakMap,D={get(e,t){if(!x.includes(t))return e[t];let n=b[t];return n||(n=b[t]=function(...e){I.set(this,B.get(this)[t](...e))}),n}};async function*v(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const n=new Proxy(t,D);for(B.set(n,t),s.set(n,f(t));t;)yield n,t=await(I.get(n)||t.continue()),I.delete(n)}function E(e,t){return t===Symbol.asyncIterator&&n(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&n(e,[IDBIndex,IDBObjectStore])}l((e=>({...e,get:(t,n,r)=>E(t,n)?v:e.get(t,n,r),has:(t,n)=>E(t,n)||e.has(t,n)})));const L="epub-reader",M="books-collection";var S={getAllBooks:async function(){const e=await m(L,1,{upgrade(e){console.log("Books database created"),e.createObjectStore(M,{autoIncrement:!0})}}),t=await e.getAllKeys(M),n=await e.getAll(M);return t.map(((e,t)=>({key:e,value:n[t]})))},getBookById:async function(e){const t=await m(L,1);return await t.get(M,e)},addBook:async function(e){const t=await m(L,1);return await t.add(M,e.object)},removeBook:async function(e){const t=await m(L,1);return await t.delete(M,e)},updateBookPosition:async function(e){const t=await m(L,1);await t.put(M,e.object,e.id)}};export{e as E,S as d};
