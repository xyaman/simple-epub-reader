import e from"./settings.js";class t{id=-1;updatedAt=0;title;creator;language;lastReadIndex=0;totalIndex=0;file;textHTML=[];contentFileName;contentsPath;#e;static async newFromExistingObject(e,n){const a=new t;return a.id=e,a.updatedAt=n.updatedAt||0,a.title=n.title,a.language=n.language,a.creator=n.creator,a.lastReadIndex=n.lastReadIndex||0,a.totalIndex=n.totalIndex||0,a.file=n.file,await a.loadFromFile(),a}static async newFromFile(e){const n=new t;return n.file=e,await n.loadFromFile(),n}get object(){return{title:this.title,updatedAt:this.updatedAt,language:this.language,creator:this.creator,lastReadIndex:this.lastReadIndex||0,totalIndex:this.totalIndex||0,file:this.file}}async loadFromFile(){const e=await this.getZip(),t=await e.file("META-INF/container.xml").async("text"),n=(new DOMParser).parseFromString(t,"application/xml").getElementsByTagName("rootfile")[0].getAttribute("full-path");let a="";n.match(/^.*\//)&&(a=n.match(/^.*\//)[0]),this.contentsPath=a;const r=await e.file(n).async("text");this.contentFileName=n;const i=(new DOMParser).parseFromString(r,"application/xml");this.title=i.getElementsByTagName("dc:title")[0].innerHTML,this.language=i.getElementsByTagName("dc:language")[0].innerHTML,this.creator=i.getElementsByTagName("dc:creator")[0].innerHTML}async getZip(){if(this.file)return this.#e=this.#e||await JSZip.loadAsync(this.file),this.#e}async getCoverBlob(){const e=await this.getZip(),t=await e.file(this.contentFileName).async("text"),n=(new DOMParser).parseFromString(t,"application/xml"),a=n.querySelector('item[properties="cover-image"]')||n.querySelector('item[media-type="image/jpeg"]');if(a){const t=this.contentsPath+a.getAttribute("href"),n=await e.file(t).async("blob");let r=n.slice(0,n.size,"image/jpeg");return URL.createObjectURL(r)}}async loadContent(){if(!this.file)return;const e=new Date,t=await this.getZip(),a=await t.file("META-INF/container.xml").async("text"),r=(new DOMParser).parseFromString(a,"application/xml").getElementsByTagName("rootfile")[0].getAttribute("full-path");let i="";r.match(/^.*\//)&&(i=r.match(/^.*\//)[0]);const o=await t.file(r).async("text"),s=(new DOMParser).parseFromString(o,"application/xml"),c={};for(const e of t.filter((e=>e.includes(".jpg")||e.includes(".jpeg")))){const a=await t.file(e.name).async("blob");let r=a.slice(0,a.size,"image/jpeg");c[n(e.name)]=URL.createObjectURL(r)}const l=s.querySelectorAll('item[media-type="application/xhtml+xml"]');for(let e=0;e<l.length;e++){const a=i+l[e].getAttribute("href");if(a.includes("navigation"))continue;const r=await t.file(a).async("text"),o=(new DOMParser).parseFromString(r,"application/xml"),s=document.createElement("div");s.innerHTML=o.querySelector("body").innerHTML,s.setAttribute("id",n(a).slice(0,-6));const d=s.querySelectorAll("image");for(let e=0;e<d.length;e++){const t=n(d[0].getAttribute("xlink:href"));d[e].setAttribute("xlink:href",c[t])}const u=s.querySelectorAll("img");for(let e=0;e<u.length;e++)n(u[e].src),u[e].src=c[n(u[e].src)];const p=s.getElementsByTagName("a");p&&[...p].forEach((e=>e.href="#"+e.href.split("#")[1])),this.textHTML.push(s)}console.log(`Epub loaded in ${new Date-e}ms`)}}function n(e){let t=/[^/]+$/;return e.match(t)?e.match(t)[0]:e}const a=(e,t)=>t.some((t=>e instanceof t));let r,i;const o=new WeakMap,s=new WeakMap,c=new WeakMap;let l={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return o.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return g(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function d(e){l=e(l)}function u(e){return(i||(i=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(f(this),t),g(this.request)}:function(...t){return g(e.apply(f(this),t))}}function p(e){return"function"==typeof e?u(e):(e instanceof IDBTransaction&&function(e){if(o.has(e))return;const t=new Promise(((t,n)=>{const a=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",i),e.removeEventListener("abort",i)},r=()=>{t(),a()},i=()=>{n(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",r),e.addEventListener("error",i),e.addEventListener("abort",i)}));o.set(e,t)}(e),a(e,r||(r=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,l):e)}function g(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const a=()=>{e.removeEventListener("success",r),e.removeEventListener("error",i)},r=()=>{t(g(e.result)),a()},i=()=>{n(e.error),a()};e.addEventListener("success",r),e.addEventListener("error",i)}));return c.set(t,e),t}(e);if(s.has(e))return s.get(e);const t=p(e);return t!==e&&(s.set(e,t),c.set(t,e)),t}const f=e=>c.get(e);function m(e,t,{blocked:n,upgrade:a,blocking:r,terminated:i}={}){const o=indexedDB.open(e,t),s=g(o);return a&&o.addEventListener("upgradeneeded",(e=>{a(g(o.result),e.oldVersion,e.newVersion,g(o.transaction),e)})),n&&o.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),s.then((e=>{i&&e.addEventListener("close",(()=>i())),r&&e.addEventListener("versionchange",(e=>r(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),s}const h=["get","getKey","getAll","getAllKeys","count"],y=["put","add","delete","clear"],w=new Map;function x(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(w.get(t))return w.get(t);const n=t.replace(/FromIndex$/,""),a=t!==n,r=y.includes(n);if(!(n in(a?IDBIndex:IDBObjectStore).prototype)||!r&&!h.includes(n))return;const i=async function(e,...t){const i=this.transaction(e,r?"readwrite":"readonly");let o=i.store;return a&&(o=o.index(t.shift())),(await Promise.all([o[n](...t),r&&i.done]))[0]};return w.set(t,i),i}d((e=>({...e,get:(t,n,a)=>x(t,n)||e.get(t,n,a),has:(t,n)=>!!x(t,n)||e.has(t,n)})));const I=["continue","continuePrimaryKey","advance"],b={},v=new WeakMap,B=new WeakMap,D={get(e,t){if(!I.includes(t))return e[t];let n=b[t];return n||(n=b[t]=function(...e){v.set(this,B.get(this)[t](...e))}),n}};async function*E(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const n=new Proxy(t,D);for(B.set(n,t),c.set(n,f(t));t;)yield n,t=await(v.get(n)||t.continue()),v.delete(n)}function A(e,t){return t===Symbol.asyncIterator&&a(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&a(e,[IDBIndex,IDBObjectStore])}d((e=>({...e,get:(t,n,a)=>A(t,n)?E:e.get(t,n,a),has:(t,n)=>A(t,n)||e.has(t,n)})));const L="epub-reader",S="books-collection";async function M(){const e=await m(L,1,{upgrade(e){console.log("Books database created"),e.createObjectStore(S,{autoIncrement:!0})}}),t=await e.getAllKeys(S),n=await e.getAll(S);return t.map(((e,t)=>({key:e,value:n[t]})))}async function j(e){const t=await m(L,1);return await t.get(S,e)}var F={getAllBooks:M,getBookById:j,addBook:async function(e){const t=await m(L,1);return await t.add(S,e.object)},removeBook:async function(e){const t=await m(L,1);return await t.delete(S,e)},updateBookPosition:async function(e){const t=await m(L,1);e.updatedAt=Date.now(),await t.put(S,e.object,e.id)},syncWithServer:async function(){const t={uploaded:[],downloaded:[]},n=e.load().uuid,a=e.load().serverAddress,r=await m(L,1);let i=await M();i=i.map((e=>({id:e.key,user_id:n,creator:e.value.creator,language:e.value.language,last_read_index:e.value.lastReadIndex,title:e.value.title,total_index:e.value.totalIndex,updated_at:e.value.updatedAt||0})));const o={};for(const e of i)o[e.title]=e;const s=await fetch(`${a}/user/sync`,{method:"POST",body:JSON.stringify({user_uuid:n,data:i})}),c=(await s.json()).updated_books;for(const e of c)if(e.title in o){const n=o[e.title];if(e.updated_at>n.updated_at){const a=await j(n.id);a.updatedAt=e.updated_at,a.lastReadIndex=e.last_read_index,a.totalIndex=e.total_index,a.id=n.id,await r.put(S,a,a.id),t.downloaded.push(a.title)}}return t}};export{t as E,F as d};
