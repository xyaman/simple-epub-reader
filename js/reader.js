import{d as e,E as t}from"./shared.js";import r from"./settings.js";class s{current_book=null;readerElem;bookContentElem;charsCounterElem;pageCounterElem;#e=[];#t=[];#r=[];#s=0;#n=0;#a=0;preferences;#o;constructor(e,t,s){this.readerElem=e,this.charsCounterElem=t,this.pageCounterElem=s,this.bookContentElem=document.createElement("div"),this.bookContentElem.setAttribute("id","book-content"),this.readerElem.append(this.bookContentElem),this.preferences=r.load(),this.updateReaderStyle()}updateReaderStyle(){this.readerElem.style.fontSize=`${this.preferences.fontSize}px`,this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,this.preferences.lightTheme&&(this.readerElem.style.color="black",this.readerElem.style.background="white",this.pageCounterElem.style.color="black",this.charsCounterElem.style.color="black",document.body.style.color="black",document.body.style.background="white")}async setCurrentBook(e){this.current_book=e,await e.loadContent();for(const e of this.current_book.textHTML)this.bookContentElem.append(e);this.#e=this.bookContentElem.querySelectorAll("p"),this.#t=[],this.current_book.totalIndex=this.#e.length;for(let e=0;e<this.#e.length;e++)this.#e[e].setAttribute("data-index",e);let t=0;for(let e=0;e<this.#e.length;e++){const r=this.#e[e].cloneNode(!0),s=r.getElementsByTagName("rt");for(let e=0;e<s.length;e++)s[e].parentNode.removeChild(s[e]);t+=a(r),this.#t.push(t)}this.charsCounterElem.innerText=`0/${t} (0%)`,this.preferences.readerIsPaginated?this.#i():this.#h()}#h(){this.current_book.lastReadIndex>0&&this.#e[this.current_book.lastReadIndex].scrollIntoView(),document.removeEventListener("scroll",this.#l.bind(this)),document.addEventListener("scroll",this.#l.bind(this))}#l(){null!==this.#o&&clearTimeout(this.#o),this.#o=setTimeout(this.#d.bind(this),150)}#d(){let t=0;for(let e=0;e<this.#e.length;e++){if(this.#e[e].getBoundingClientRect().bottom>0)break;const r=this.#e[e].getAttribute("data-index");t=parseInt(r)}if(t!=this.current_book.lastReadIndex){this.current_book.lastReadIndex=t,e.updateBookPosition(this.current_book);const r=this.#t[t]/this.#t[this.#t.length-1]*100;this.charsCounterElem.innerText=`${this.#t[t]}/${this.#t[this.#t.length-1]} (${r.toFixed(2)}%)`}}#i(){this.readerElem.style.overflow="hidden",this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,document.documentElement.style.overscrollBehavior="none",document.body.style.overscrollBehavior="none";const e=()=>{const e=this.readerElem.clientHeight;let t=0,r=[];this.#r=[],this.#s=0;const s=this.bookContentElem.querySelectorAll("p:not(:has(img)), img, svg");for(let n=0;n<s.length;n++){const a=s[n].offsetHeight,o=s[n].cloneNode(!0);"svg"!==o.localName&&"img"!==o.localName||(o.style.maxHeight=`${e}px`),t+a<=e?(r.push(o),t+=a):(r.length>0&&this.#c(r),r=[o],t=a)}r.length>0&&this.#c(r)};e(),this.goToPage(this.#s),document.addEventListener("keydown",(e=>{"ArrowDown"===e.key||"PageDown"===e.key?this.goToPage(this.#s+1):"ArrowUp"!==e.key&&"PageUp"!==e.key||this.goToPage(this.#s-1)})),window.addEventListener("resize",(()=>{this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,this.bookContentElem.innerHTML="";for(const e of this.current_book.textHTML)this.bookContentElem.append(e);this.#e=this.bookContentElem.querySelectorAll("p"),e(),this.goToPage(this.#s)})),document.addEventListener("touchstart",(e=>{this.#n=e.changedTouches[0].screenX})),document.addEventListener("touchend",(e=>{this.#a=e.changedTouches[0].screenX;Math.abs(this.#a-this.#n)<30||(this.#a<this.#n?this.goToPage(this.#s+1):this.goToPage(this.#s-1),console.log(this.#r[this.#s]))}))}#c(e){if(!this.preferences.readerIsPaginated)return;const t=document.createElement("div");t.classList.add("page");for(let r=0;r<e.length;r++){const s=e[r].getAttribute("data-index");s&&this.current_book.lastReadIndex>1&&parseInt(s)===this.current_book.lastReadIndex&&(this.#s=this.#r.length),t.appendChild(e[r])}this.#r.push(t)}goToPage(t){this.#s=Math.max(0,Math.min(t,this.#r.length-1)),this.bookContentElem.innerHTML="",this.bookContentElem.appendChild(this.#r[this.#s]);let r=this.current_book.lastReadIndex-1;const s=this.#r[this.#s].querySelector("p");if(s){const e=s.getAttribute("data-index")||null;r=e?Math.max(parseInt(e)-1,0):this.current_book.lastReadIndex,this.current_book.lastReadIndex=r+1}const n=this.#t[r]/this.#t.slice(-1)[0]*100;this.charsCounterElem.innerText=`${this.#t[r]}/${this.#t.slice(-1)[0]} (${n.toFixed(2)}%)`,this.pageCounterElem.innerText=`Page ${this.#s}/${this.current_book.totalIndex}`,e.updateBookPosition(this.current_book)}}const n=/[^0-9A-Z○◯々-〇〻ぁ-ゖゝ-ゞァ-ヺー０-９Ａ-Ｚｦ-ﾝ\p{Radical}\p{Unified_Ideograph}]+/gimu;function a(e){return e.textContent?(t=e.textContent.replace(n,""),Array.from(t).length):0;var t}document.addEventListener("DOMContentLoaded",(async function(){const r=new s(document.getElementById("reader"),document.getElementById("character-counter"),document.getElementById("page-counter")),n=new URLSearchParams(window.location.search),a=parseInt(n.get("id")),o=await e.getBookById(a);if(o){const e=await t.newFromExistingObject(a,o);await r.setCurrentBook(e)}}));
