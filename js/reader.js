import{d as e,E as t}from"./db-Cnd-sZn5.js";import n from"./settings.js";class r{current_book=null;readerElem;bookContentElem;charsCounterElem;pageCounterElem;#e=[];#t=[];#n=[];#r=0;#s=0;#a=0;preferences;#o;constructor(e,t,r){this.readerElem=e,this.charsCounterElem=t,this.pageCounterElem=r,this.bookContentElem=document.createElement("div"),this.bookContentElem.setAttribute("id","book-content"),this.readerElem.append(this.bookContentElem),this.preferences=n.load(),this.updateReaderStyle()}updateReaderStyle(){this.readerElem.style.fontSize=`${this.preferences.fontSize}px`,this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`}async setCurrentBook(e){this.current_book=e,await e.loadContent();for(const e of this.current_book.textHTML)this.bookContentElem.append(e);this.#e=this.bookContentElem.querySelectorAll("p"),this.#t=[],this.current_book.totalIndex=this.#e.length;for(let e=0;e<this.#e.length;e++)this.#e[e].setAttribute("data-index",e);let t=0;for(let e=0;e<this.#e.length;e++){const n=this.#e[e].cloneNode(!0),r=n.getElementsByTagName("rt");for(let e=0;e<r.length;e++)r[e].parentNode.removeChild(r[e]);t+=a(n),this.#t.push(t)}this.charsCounterElem.innerText=`0/${t} (0%)`,this.preferences.readerIsPaginated?this.#i():this.#h()}#h(){this.current_book.lastReadIndex>0&&this.#e[this.current_book.lastReadIndex].scrollIntoView(),document.removeEventListener("scroll",this.#d.bind(this)),document.addEventListener("scroll",this.#d.bind(this))}#d(){null!==this.#o&&clearTimeout(this.#o),this.#o=setTimeout(this.#c.bind(this),150)}#c(){let t=0;for(let e=0;e<this.#e.length;e++){if(this.#e[e].getBoundingClientRect().bottom>0)break;const n=this.#e[e].getAttribute("data-index");t=parseInt(n)}if(t!=this.current_book.lastReadIndex){this.current_book.lastReadIndex=t,e.updateBookPosition(this.current_book);const n=this.#t[t]/this.#t[this.#t.length-1]*100;this.charsCounterElem.innerText=`${this.#t[t]}/${this.#t[this.#t.length-1]} (${n.toFixed(2)}%)`}}#i(){this.readerElem.style.overflow="hidden",this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,document.documentElement.style.overscrollBehavior="none",document.body.style.overscrollBehavior="none";const e=()=>{const e=this.readerElem.clientHeight;let t=0,n=[];this.#n=[],this.#r=0;const r=this.bookContentElem.querySelectorAll("p:not(:has(img)), img, svg");for(let s=0;s<r.length;s++){const a=r[s].offsetHeight,o=r[s].cloneNode(!0);"svg"!==o.localName&&"img"!==o.localName||(o.style.maxHeight=`${e}px`),t+a<=e?(n.push(o),t+=a):(n.length>0&&this.#l(n),n=[o],t=a)}n.length>0&&this.#l(n)};e(),this.goToPage(this.#r),document.addEventListener("keydown",(e=>{"ArrowDown"===e.key||"PageDown"===e.key?this.goToPage(this.#r+1):"ArrowUp"!==e.key&&"PageUp"!==e.key||this.goToPage(this.#r-1)})),window.addEventListener("resize",(()=>{this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,this.bookContentElem.innerHTML="";for(const e of this.current_book.textHTML)this.bookContentElem.append(e);this.#e=this.bookContentElem.querySelectorAll("p"),e(),this.goToPage(this.#r)})),document.addEventListener("touchstart",(e=>{this.#s=e.changedTouches[0].screenX})),document.addEventListener("touchend",(e=>{this.#a=e.changedTouches[0].screenX;Math.abs(this.#a-this.#s)<30||(this.#a<this.#s?this.goToPage(this.#r+1):this.goToPage(this.#r-1),console.log(this.#n[this.#r]))}))}#l(e){if(!this.preferences.readerIsPaginated)return;const t=document.createElement("div");t.classList.add("page");for(let n=0;n<e.length;n++){const r=e[n].getAttribute("data-index");r&&this.current_book.lastReadIndex>1&&parseInt(r)===this.current_book.lastReadIndex&&(this.#r=this.#n.length),t.appendChild(e[n])}this.#n.push(t)}goToPage(t){this.#r=Math.max(0,Math.min(t,this.#n.length-1)),this.bookContentElem.innerHTML="",this.bookContentElem.appendChild(this.#n[this.#r]);let n=this.current_book.lastReadIndex-1;const r=this.#n[this.#r].querySelector("p");if(r){const e=r.getAttribute("data-index")||null;n=e?Math.max(parseInt(e)-1,0):this.current_book.lastReadIndex}r&&(this.current_book.lastReadIndex=n+1);const s=this.#t[n]/this.#t.slice(-1)[0]*100;this.charsCounterElem.innerText=`${this.#t[n]}/${this.#t.slice(-1)[0]} (${s.toFixed(2)}%)`,this.pageCounterElem.innerText=`Page ${this.#r}/${this.current_book.totalIndex}`,e.updateBookPosition(this.current_book)}}const s=/[^0-9A-Z○◯々-〇〻ぁ-ゖゝ-ゞァ-ヺー０-９Ａ-Ｚｦ-ﾝ\p{Radical}\p{Unified_Ideograph}]+/gimu;function a(e){return e.textContent?(t=e.textContent.replace(s,""),Array.from(t).length):0;var t}document.addEventListener("DOMContentLoaded",(async function(){const n=new r(document.getElementById("reader"),document.getElementById("character-counter"),document.getElementById("page-counter")),s=new URLSearchParams(window.location.search),a=parseInt(s.get("id")),o=await e.getBookById(a);if(o){const e=await t.newFromExistingObject(a,o);await n.setCurrentBook(e)}}));
