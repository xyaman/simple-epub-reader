import{u as e,b as t,E as s}from"./shared.js";import{load as n}from"./settings.js";class a{currentBook;readerElem;bookContentElem;charsCounterElem;pageCounterElem;paragraphs;paragraphsCharsAcum=[];pages=[];pageIndex=0;swipeStartX=0;swipeEndX=0;preferences;scrollTimer;constructor(e,t,s){this.readerElem=document.getElementById(e),this.charsCounterElem=document.getElementById(t),this.pageCounterElem=document.getElementById(s),this.bookContentElem=document.createElement("div"),this.bookContentElem.setAttribute("id","book-content"),this.readerElem.append(this.bookContentElem),this.preferences=n(),this.updateReaderStyle()}updateReaderStyle(){this.readerElem.style.fontSize=`${this.preferences.readerFontSize}px`,this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,"light"===this.preferences.theme&&(this.readerElem.style.color="black",this.readerElem.style.background="white",this.pageCounterElem.style.color="black",this.charsCounterElem.style.color="black",document.body.style.color="black",document.body.style.background="white")}async setBook(e){const t=Date.now();this.bookContentElem.innerHTML="Loading...",this.currentBook=e,await e.loadContent(),this.bookContentElem.innerHTML="";for(const e of this.currentBook.textHTML)this.bookContentElem.append(e);this.paragraphs=this.bookContentElem.querySelectorAll("p"),this.paragraphsCharsAcum=[],this.currentBook.totalIndex=this.paragraphs.length;for(let e=0;e<this.paragraphs.length;e++)this.paragraphs[e].setAttribute("data-index",`${e}`);let s=0;for(let e=0;e<this.paragraphs.length;e++){const t=this.paragraphs[e].cloneNode(!0),n=t.getElementsByTagName("rt");for(let e=0;e<n.length;e++)n[e].parentNode?.removeChild(n[e]);s+=o(t),this.paragraphsCharsAcum.push(s)}this.charsCounterElem.innerText=`0/${s} (0%)`,"paginated"===this.preferences.readerMode?this.setupPaginated():this.setupContinous(),console.log(`Reader loaded in ${Date.now()-t}ms`)}setupContinous(){this.currentBook&&(this.currentBook.lastReadIndex>0&&this.paragraphs[this.currentBook.lastReadIndex].scrollIntoView(),document.removeEventListener("scroll",this.continousHandleTimer.bind(this)),document.addEventListener("scroll",this.continousHandleTimer.bind(this)))}continousHandleTimer(){null!==this.scrollTimer&&clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout(this.continousHandleScroll.bind(this),150)}continousHandleScroll(){if(!this.currentBook)return;let t=0;for(let e=0;e<this.paragraphs.length;e++){if(this.paragraphs[e].getBoundingClientRect().bottom>0)break;const s=this.paragraphs[e].getAttribute("data-index")||"0";t=parseInt(s)}if(t!=this.currentBook.lastReadIndex){this.currentBook.lastReadIndex=t,e(this.currentBook);const s=this.paragraphsCharsAcum[t]/this.paragraphsCharsAcum[this.paragraphsCharsAcum.length-1]*100;this.charsCounterElem.innerText=`${this.paragraphsCharsAcum[t]}/${this.paragraphsCharsAcum[this.paragraphsCharsAcum.length-1]} (${s.toFixed(2)}%)`}}setupPaginated(){this.readerElem.style.overflow="hidden",this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,document.documentElement.style.overscrollBehavior="none",document.body.style.overscrollBehavior="none";const e=()=>{const e=this.readerElem.clientHeight;let t=0,s=[];this.pages=[],this.pageIndex=0;const n=this.bookContentElem.querySelectorAll("p:not(:has(img)), img, svg");for(let a=0;a<n.length;a++){const r=n[a].offsetHeight,o=n[a].cloneNode(!0);"svg"!==o.localName&&"img"!==o.localName||(o.style.maxHeight=`${e}px`),t+r<=e?(s.push(o),t+=r):(s.length>0&&this.paginatedCreatePage(s),s=[o],t=r)}s.length>0&&this.paginatedCreatePage(s)};e(),this.goToPage(this.pageIndex),document.addEventListener("keydown",(e=>{"ArrowDown"===e.key||"PageDown"===e.key?this.goToPage(this.pageIndex+1):"ArrowUp"!==e.key&&"PageUp"!==e.key||this.goToPage(this.pageIndex-1)})),window.addEventListener("resize",(()=>{this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,this.bookContentElem.innerHTML="";for(const e of this.currentBook.textHTML)this.bookContentElem.append(e);this.paragraphs=this.bookContentElem.querySelectorAll("p"),e(),this.goToPage(this.pageIndex)})),document.addEventListener("touchstart",(e=>{this.swipeStartX=e.changedTouches[0].screenX})),document.addEventListener("touchend",(e=>{this.swipeEndX=e.changedTouches[0].screenX;Math.abs(this.swipeEndX-this.swipeStartX)<30||(this.swipeEndX<this.swipeStartX?this.goToPage(this.pageIndex+1):this.goToPage(this.pageIndex-1),console.log(this.pages[this.pageIndex]))}))}paginatedCreatePage(e){const t=document.createElement("div");t.classList.add("page");for(let s=0;s<e.length;s++){const n=e[s].getAttribute("data-index");n&&this.currentBook.lastReadIndex>1&&parseInt(n)===this.currentBook.lastReadIndex&&(this.pageIndex=this.pages.length),t.appendChild(e[s])}this.pages.push(t)}goToPage(t){this.pageIndex=Math.max(0,Math.min(t,this.pages.length-1)),this.bookContentElem.innerHTML="",this.bookContentElem.appendChild(this.pages[this.pageIndex]);let s=this.currentBook.lastReadIndex-1;const n=this.pages[this.pageIndex].querySelector("p");if(n){const e=n.getAttribute("data-index")||null;s=e?Math.max(parseInt(e)-1,0):this.currentBook.lastReadIndex,this.currentBook.lastReadIndex=s+1}const a=this.paragraphsCharsAcum[s]/this.paragraphsCharsAcum.slice(-1)[0]*100;this.charsCounterElem.innerText=`${this.paragraphsCharsAcum[s]}/${this.paragraphsCharsAcum.slice(-1)[0]} (${a.toFixed(2)}%)`,this.pageCounterElem.innerText=`Page ${this.pageIndex}/${this.currentBook.totalIndex}`,e(this.currentBook)}}const r=/[^0-9A-Z○◯々-〇〻ぁ-ゖゝ-ゞァ-ヺー０-９Ａ-Ｚｦ-ﾝ\p{Radical}\p{Unified_Ideograph}]+/gimu;function o(e){return e.textContent?(t=e.textContent.replace(r,""),Array.from(t).length):0;var t}document.addEventListener("DOMContentLoaded",(async function(){const e=new URLSearchParams(window.location.search).get("id");if(!e||isNaN(parseInt(e)))return;const n=parseInt(e),r=await t(n);if(r){const e=new a("reader","character-counter","page-counter"),t=await s.newFromExistingObject(n,r);await e.setBook(t)}}));export{a as Reader};
