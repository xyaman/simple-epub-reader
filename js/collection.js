import{g as e,E as t,a as s,r as o,s as d}from"./shared.js";import"./settings.js";class a{elem;modalElem;books=[];constructor(e,t){this.elem=e,this.modalElem=t,this.loadBooks().then((()=>console.log("[Collection] All books have been loaded")))}async loadBooks(){const s=await e();for(const e of s){const s=await t.newFromExistingObject(e.key,e.value);this.books.push(s)}await this.render(),console.log(s)}async addBookFromFile(e){const o=await t.newFromFile(e),d=await s(o);o.id=d,console.log("book added succesfully"),await o.loadContent(),this.books.push(o),await this.render()}async render(){this.elem.innerHTML="";const e=document.createElement("div");e.classList.add("columns","is-multiline","is-mobile");for(let t=0;t<this.books.length;t++){const s=document.createElement("div");s.classList.add("column","is-half-mobile","is-one-third-tablet","is-one-quarter-desktop","is-one-fifth-fullhd");const d=document.createElement("div");d.setAttribute("id","card-container"),s.appendChild(d);const a=document.createElement("a");d.appendChild(a),a.classList.add("card"),a.href="/reader.html?id="+this.books[t].id;const n=document.createElement("div");a.appendChild(n),n.classList.add("card-image");const i=document.createElement("figure");n.appendChild(i),i.classList.add("image","is-3by4");const l=document.createElement("img");i.appendChild(l),l.style.objectFit="cover",l.src=await this.books[t].getCoverBlob();const c=document.createElement("a");c.classList.add("tag","is-delete"),c.setAttribute("id","delete-button"),d.appendChild(c);const r=document.createElement("progress");r.classList.add("progress","is-radiusless"),r.setAttribute("value",`${this.books[t].lastReadIndex||0}`),r.setAttribute("max",`${this.books[t].totalIndex||1}`),d.appendChild(r),c.onclick=async()=>{await o(this.books[t].id),this.books.splice(t,1),await this.render()},e.appendChild(s)}this.elem.appendChild(e)}showModal(e){this.modalElem.innerHTML="",this.modalElem.classList.add("modal","is-active","is-clipped");const t=document.createElement("div");t.classList.add("modal-background"),this.modalElem.appendChild(t),t.onclick=this.hideModal.bind(this);const s=document.createElement("div");s.classList.add("modal-content"),this.modalElem.appendChild(s);const o=document.createElement("div");o.classList.add("content","box"),s.appendChild(o);const d=document.createElement("p");o.appendChild(d),d.innerHTML=e;const a=document.createElement("button");a.classList.add("modal-close","is-large"),this.modalElem.appendChild(a),a.onclick=this.hideModal.bind(this)}hideModal(){this.modalElem.innerHTML="",this.modalElem.setAttribute("class","")}async syncWithServer(){this.showModal("Starting sync");try{const e=await d();e.downloaded.length+e.uploaded.length>0?(this.showModal(`<strong>Succesfully synced</strong><br> ↑ ${e.uploaded.length} book(s) uploaded<br> ↓ ${e.downloaded.length} book(s) downloaded`),await this.loadBooks(),await this.render()):this.showModal("<strong>Succesfully synced</strong><br> No changes")}catch(e){this.showModal(`An error has ocurred: ${e}`)}}}document.addEventListener("DOMContentLoaded",(()=>{let e;const t=document.getElementById("books-container"),s=document.getElementById("modal");t&&s&&(e=new a(t,s)),document.getElementById("file-input")?.addEventListener("change",(async function(t){const s=t.target.files;s&&s.length>0&&e.addBookFromFile(s[0])})),document.getElementById("sync")?.addEventListener("click",(async function(){await e.syncWithServer()}))}));
