import{load as e}from"./settings.js";import{u as t}from"./shared.js";class s{currentBook;readerElem;bookContentElem;charsCounterElem;pageCounterElem;paragraphs;paragraphsCharsAcum=[];pages=[];pageIndex=0;swipeStartX=0;swipeEndX=0;preferences;scrollTimer;constructor(t,s,r){this.readerElem=t,this.charsCounterElem=s,this.pageCounterElem=r,this.bookContentElem=document.createElement("div"),this.bookContentElem.setAttribute("id","book-content"),this.readerElem.append(this.bookContentElem),this.preferences=e(),this.updateReaderStyle()}updateReaderStyle(){this.readerElem.style.fontSize=`${this.preferences.readerFontSize}px`,this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,this.preferences.lightTheme&&(this.readerElem.style.color="black",this.readerElem.style.background="white",this.pageCounterElem.style.color="black",this.charsCounterElem.style.color="black",document.body.style.color="black",document.body.style.background="white")}async setBook(e){this.currentBook=e,await e.loadContent();for(const e of this.currentBook.textHTML)this.bookContentElem.append(e);this.paragraphs=this.bookContentElem.querySelectorAll("p"),this.paragraphsCharsAcum=[],this.currentBook.totalIndex=this.paragraphs.length;for(let e=0;e<this.paragraphs.length;e++)this.paragraphs[e].setAttribute("data-index",`${e}`);let t=0;for(let e=0;e<this.paragraphs.length;e++){const s=this.paragraphs[e].cloneNode(!0),r=s.getElementsByTagName("rt");for(let e=0;e<r.length;e++)r[e].parentNode?.removeChild(r[e]);t+=a(s),this.paragraphsCharsAcum.push(t)}this.charsCounterElem.innerText=`0/${t} (0%)`,this.preferences.readerIsPaginated?this.setupPaginated():this.setupContinous()}setupContinous(){this.currentBook&&(this.currentBook.lastReadIndex>0&&this.paragraphs[this.currentBook.lastReadIndex].scrollIntoView(),document.removeEventListener("scroll",this.continousHandleTimer.bind(this)),document.addEventListener("scroll",this.continousHandleTimer.bind(this)))}continousHandleTimer(){null!==this.scrollTimer&&clearTimeout(this.scrollTimer),this.scrollTimer=setTimeout(this.continousHandleScroll.bind(this),150)}continousHandleScroll(){if(!this.currentBook)return;let e=0;for(let t=0;t<this.paragraphs.length;t++){if(this.paragraphs[t].getBoundingClientRect().bottom>0)break;const s=this.paragraphs[t].getAttribute("data-index")||"0";e=parseInt(s)}if(e!=this.currentBook.lastReadIndex){this.currentBook.lastReadIndex=e,t(this.currentBook);const s=this.paragraphsCharsAcum[e]/this.paragraphsCharsAcum[this.paragraphsCharsAcum.length-1]*100;this.charsCounterElem.innerText=`${this.paragraphsCharsAcum[e]}/${this.paragraphsCharsAcum[this.paragraphsCharsAcum.length-1]} (${s.toFixed(2)}%)`}}setupPaginated(){this.readerElem.style.overflow="hidden",this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,document.documentElement.style.overscrollBehavior="none",document.body.style.overscrollBehavior="none";const e=()=>{const e=this.readerElem.clientHeight;let t=0,s=[];this.pages=[],this.pageIndex=0;const r=this.bookContentElem.querySelectorAll("p:not(:has(img)), img, svg");for(let a=0;a<r.length;a++){const n=r[a].offsetHeight,o=r[a].cloneNode(!0);"svg"!==o.localName&&"img"!==o.localName||(o.style.maxHeight=`${e}px`),t+n<=e?(s.push(o),t+=n):(s.length>0&&this.paginatedCreatePage(s),s=[o],t=n)}s.length>0&&this.paginatedCreatePage(s)};e(),this.goToPage(this.pageIndex),document.addEventListener("keydown",(e=>{"ArrowDown"===e.key||"PageDown"===e.key?this.goToPage(this.pageIndex+1):"ArrowUp"!==e.key&&"PageUp"!==e.key||this.goToPage(this.pageIndex-1)})),window.addEventListener("resize",(()=>{this.readerElem.style.height=`${Math.ceil(.8*window.innerHeight)}px`,this.bookContentElem.innerHTML="";for(const e of this.currentBook.textHTML)this.bookContentElem.append(e);this.paragraphs=this.bookContentElem.querySelectorAll("p"),e(),this.goToPage(this.pageIndex)})),document.addEventListener("touchstart",(e=>{this.swipeStartX=e.changedTouches[0].screenX})),document.addEventListener("touchend",(e=>{this.swipeEndX=e.changedTouches[0].screenX;Math.abs(this.swipeEndX-this.swipeStartX)<30||(this.swipeEndX<this.swipeStartX?this.goToPage(this.pageIndex+1):this.goToPage(this.pageIndex-1),console.log(this.pages[this.pageIndex]))}))}paginatedCreatePage(e){if(!this.preferences.readerIsPaginated)return;const t=document.createElement("div");t.classList.add("page");for(let s=0;s<e.length;s++){const r=e[s].getAttribute("data-index");r&&this.currentBook.lastReadIndex>1&&parseInt(r)===this.currentBook.lastReadIndex&&(this.pageIndex=this.pages.length),t.appendChild(e[s])}this.pages.push(t)}goToPage(e){this.pageIndex=Math.max(0,Math.min(e,this.pages.length-1)),this.bookContentElem.innerHTML="",this.bookContentElem.appendChild(this.pages[this.pageIndex]);let s=this.currentBook.lastReadIndex-1;const r=this.pages[this.pageIndex].querySelector("p");if(r){const e=r.getAttribute("data-index")||null;s=e?Math.max(parseInt(e)-1,0):this.currentBook.lastReadIndex,this.currentBook.lastReadIndex=s+1}const a=this.paragraphsCharsAcum[s]/this.paragraphsCharsAcum.slice(-1)[0]*100;this.charsCounterElem.innerText=`${this.paragraphsCharsAcum[s]}/${this.paragraphsCharsAcum.slice(-1)[0]} (${a.toFixed(2)}%)`,this.pageCounterElem.innerText=`Page ${this.pageIndex}/${this.currentBook.totalIndex}`,t(this.currentBook)}}const r=/[^0-9A-Z○◯々-〇〻ぁ-ゖゝ-ゞァ-ヺー０-９Ａ-Ｚｦ-ﾝ\p{Radical}\p{Unified_Ideograph}]+/gimu;function a(e){return e.textContent?(t=e.textContent.replace(r,""),Array.from(t).length):0;var t}export{s as Reader};
